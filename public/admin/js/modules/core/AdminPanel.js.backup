// public/admin/js/modules/core/AdminPanel.js
import { AuthService } from '../services/AuthService.js';
import { ApiService } from '../services/ApiService.js';
import { DeviceManager } from './DeviceManager.js';
import { WebSocketService } from './WebSocketService.js';
import { UIManager } from '../ui/UIManager.js';
import { handleError, withErrorBoundary } from '../utils/errorHandler.js';

/**
 * Main AdminPanel class that orchestrates the admin dashboard
 */
class AdminPanel {
    /**
     * Initialize a new AdminPanel instance
     */
    constructor() {
        try {
            console.log('Initializing AdminPanel...');

            // Initialize properties
            this.token = AuthService.getToken();
            this.currentSection = 'dashboard';
            this.currentDeviceId = null;
            this.isInitialized = false;
            this.isLoading = false;
            this.pendingOperations = new Map();
            this.refreshInterval = null;

            // Initialize UI first
            console.log('Initializing UIManager...');
            this.ui = new UIManager();
            this.ui.setLoading(true, 'Initializing...');

            // Initialize other services
            console.log('Initializing other services...');
            this.api = new ApiService();
            this.deviceManager = new DeviceManager(this.api);

            // Initialize WebSocket with error handling
            try {
                // Create a mock WebSocket by default
                this.ws = this.createMockWebSocket();

                // Bind WebSocket handler methods
                this.handleWebSocketMessage = this.handleWebSocketMessage?.bind(this) || null;

                // Initialize WebSocket service with the bound handler
                try {
                    this.ws = new WebSocketService(this.handleWebSocketMessage);
                    console.log('WebSocket service initialized successfully');

                    // Setup WebSocket listeners after initialization
                    if (this.ws && typeof this.setupWebSocketListeners === 'function') {
                        this.setupWebSocketListeners();
                    }
                } catch (wsError) {
                    console.warn('Failed to initialize WebSocket, using mock service:', wsError);
                }
            } catch (error) {
                console.warn('Error during WebSocket initialization:', error);
            }

            // Bind methods with error handling
            this.init = withErrorBoundary(this.init.bind(this), {
                context: this,
                onError: (error) => {
                    console.error('Error in initialization:', error);
                    this.ui.showNotification('Failed to initialize application', 'error');
                    this.ui.setLoading(false);
                }
            });

            // Initialize after DOM is ready
            console.log('Scheduling DOM initialization...');
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.initializeAfterDOM());
            } else {
                this.initializeAfterDOM();
            }

        } catch (error) {
            console.error('Fatal error in AdminPanel constructor:', error);
            // If UI is available, show error
            if (this.ui) {
                this.ui.setLoading(false);
                this.ui.showNotification('Critical error during initialization', 'error');
            } else {
                // Last resort error display
                document.body.innerHTML = `
                    <div style="padding: 2rem; font-family: Arial, sans-serif;">
                        <h2 style="color: #dc3545;">Critical Error</h2>
                        <p>Failed to initialize the application. Please check the console for details.</p>
                        <p>${error.message || 'Unknown error occurred'}</p>
                        <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Reload Page
                        </button>
                    </div>
                `;
            }
            throw error; // Re-throw to be caught by global error handler
        }
    }

    /**
     * Initialize after DOM is fully loaded
     */
    async initializeAfterDOM() {
        try {
            // DOM is ready, initialize the application
            await this.init();
        } catch (error) {
            console.error('Failed to initialize application:', error);
            this.showFatalError('Initialization Failed', 'Failed to initialize the application. Please check the console for details.');
            throw error; // Re-throw to be caught by the global error handler
        }
    }

    /**
     * Set up error handling for the application
     */
    setupErrorHandling() {
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            this.ui.showNotification(
                'An unexpected error occurred',
                'error',
                'Please check the console for details.'
            );
        });

        // Handle global errors
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error || event.message);
            this.ui.showNotification(
                'A critical error occurred',
                'error',
                'Please check the console for details.'
            );
            // Prevent the default error handler
            event.preventDefault();
        });
    }

    /**
     * Cache DOM elements for better performance
     */
    cacheElements() {
        // This will be implemented based on your HTML structure
        this.elements = {
            // Add your DOM elements here
        };
    }

    /**
     * Set up accessibility features
     */
    setupAccessibility() {
        // Add any accessibility-related code here
        document.documentElement.setAttribute('lang', 'en');

        // Make sure all interactive elements are focusable
        const interactiveElements = document.querySelectorAll('button, [href], input, select, textarea, [tabindex]');
        interactiveElements.forEach(el => {
            el.setAttribute('tabindex', '0');
        });
    }

    /**
     * Bind event listeners
     */
    bindEvents() {
        // Add your event listeners here
    }

    /**
     * Show a fatal error message to the user
     * @param {string} title - The title of the error
     * @param {string} message - The error message
     */
    showFatalError(title = 'Fatal Error', message = 'The application encountered a critical error and cannot continue.') {
        console.error(`[FATAL] ${title}: ${message}`);

        // If UI is available, show error
        if (this.ui && typeof this.ui.showError === 'function') {
            this.ui.showError(title, message);
            return;
        }

        // Fallback to basic error display
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger m-3';
        errorDiv.role = 'alert';
        errorDiv.innerHTML = `
            <h4 class="alert-heading">${title}</h4>
            <p>${message}</p>
            <hr>
            <p class="mb-0">
                <button class="btn btn-sm btn-outline-danger" onclick="window.location.reload()">
                    Reload Application
                </button>
            </p>
        `;

        // Clear the page and show error
        document.body.innerHTML = '';
        document.body.appendChild(errorDiv);

        // Also log to console
        console.error('Fatal error details:', {title, message});
    }

    /**
     * Main initialization method
     */
    async init() {
        try {
            // Check authentication
            if (await AuthService.verifySession()) {
                await this.initializeApp();
            } else {
                this.showLogin();
            }
        } catch (error) {
            handleError('Initialization error:', error, this.ui);
            throw error;
        }
    }

    /**
     * Initialize the application
     */
    async initializeApp() {
        try {
            this.setLoading(true, 'Initializing...');

            // Initialize components
            await this.initializeComponents();

            // Check for device ID in URL
            await this.handleDeepLinking();

            // Connect to WebSocket
            this.ws.connect();

            // Initialize real-time updates
            this.initializeRealtimeUpdates();

        } catch (error) {
            handleError('Failed to initialize application', error, this.ui);
            throw error;
        } finally {
            this.setLoading(false);
        }
    }

    /**
     * Handle deep linking (URL parameters)
     */
    async handleDeepLinking() {
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('device');

        if (deviceId) {
            try {
                const device = await this.deviceManager.getDeviceById(deviceId);
                if (device) {
                    this.currentDeviceId = device.id;
                    this.showSection('device-info', device);
                    return;
                }
            } catch (error) {
                handleError(`Failed to load device ${deviceId}`, error, this.ui);
            }
        }

        // Default to overview if no device or error
        this.showSection('overview');
    }

    /**
     * Load dashboard statistics
     */
    async loadDashboardStats() {
        try {
            // Try to get dashboard stats, but don't fail if the endpoint doesn't exist
            try {
                const stats = await this.api.get('/dashboard/stats').catch(() => ({}));
                return stats?.data || stats || {};
            } catch (error) {
                console.warn('Dashboard stats endpoint not available, using empty stats');
                return {};
            }
        } catch (error) {
            handleError('Failed to load dashboard stats', error, this.ui);
            return {};
        }
    }

    /**
     * Initialize application components
     */
    /**
     * Update the devices list in the UI
     */
    updateDevicesList(devices = []) {
        try {
            const devicesContainer = document.getElementById('devices-container');
            if (!devicesContainer) {
                console.warn('Devices container not found');
                return;
            }

            if (!Array.isArray(devices) || devices.length === 0) {
                devicesContainer.innerHTML = '<div class="alert alert-info">No devices found</div>';
                return;
            }

            // Simple device list rendering - update this based on your UI needs
            devicesContainer.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>ID</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${devices.map(device => `
                                <tr data-device-id="${device.id}">
                                    <td>${device.name || 'Unnamed Device'}</td>
                                    <td><code>${device.id || 'N/A'}</code></td>
                                    <td>
                                        <span class="badge bg-${device.status === 'online' ? 'success' : 'secondary'}">
                                            ${device.status || 'unknown'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary view-device" data-id="${device.id}">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (error) {
            console.error('Error updating devices list:', error);
        }
    }

    /**
     * Update dashboard statistics in the UI
     */
    updateDashboardStats(stats = {}) {
        try {
            const statsContainer = document.getElementById('stats-container');
            if (!statsContainer) {
                console.warn('Stats container not found');
                return;
            }

            // Simple stats rendering - update this based on your UI needs
            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Devices</h4>
                        <p>${stats.totalDevices || 0}</p>
                    </div>
                    <div class="stat-card">
                        <h4>Active Devices</h4>
                        <p>${stats.activeDevices || 0}</p>
                    </div>
                    <!-- Add more stats as needed -->
                </div>
            `;
        } catch (error) {
            console.error('Error updating dashboard stats:', error);
        }
    }

    /**
     * Initialize data tables (if used in your application)
     */
    initializeDataTables() {
        // Initialize any data tables if needed
        const tables = document.querySelectorAll('.data-table');
        tables.forEach(table => {
            // Initialize your data table library here if needed
            console.log('Initializing data table:', table);
        });
    }

    /**
     * Initialize charts (if used in your application)
     */
    initializeCharts() {
        // Initialize any charts if needed
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
            // Initialize your chart library here if needed
            console.log('Initializing chart in container:', container);
        });
    }

    async initializeComponents() {
        try {
            // Load initial data
            const [devices, stats] = await Promise.all([
                // Try to load devices, but don't fail if the endpoint is not available
                this.deviceManager.loadDevices().catch(error => {
                    console.warn('Could not load devices:', error.message);
                    return [];
                }),
                this.loadDashboardStats()
            ]);

            // Update UI
            this.updateDevicesList(devices);
            this.updateDashboardStats(stats);

        } catch (error) {
            handleError('Failed to initialize components', error, this.ui);
            throw error;
        }
    }

    /**
     * Initialize real-time updates using WebSocket
     * @private
     */
    initializeRealtimeUpdates() {
        try {
            // Create a mock WebSocket service for fallback
            /**
             * Create a mock WebSocket service for fallback
             * @returns {Object} Mock WebSocket service
             */
            createMockWebSocket()
            {
                console.log('Creating mock WebSocket service');
                return {
                    on: (event, callback) => {
                        console.log(`[Mock] Added ${event} listener`);
                        return this;
                    },
                    off: (event) => {
                        console.log(`[Mock] Removed ${event} listener`);
                        return this;
                    },
                    send: (data) => {
                        console.log('[Mock] Sending data:', data);
                        return Promise.resolve();
                    },
                    connect: () => {
                        console.log('[Mock] WebSocket connected');
                        return this;
                    },
                    disconnect: () => {
                        console.log('[Mock] WebSocket disconnected');
                        return this;
                    }
                };
            }


            setupWebSocketListeners()
            {
                if (!this.ws) return;

                this.ws.on('connect', () => {
                    console.log('WebSocket connected');
                    if (this.currentDeviceId) {
                        this.subscribeToDevice(this.currentDeviceId);
                    }
                });

                this.ws.on('disconnect', () => {
                    console.log('WebSocket disconnected');
                });

                this.ws.on('error', (error) => {
                    console.error('WebSocket error:', error);
                });
            }

            /**
             * Subscribe to device updates
             * @param {string} deviceId - The ID of the device to subscribe to
             */
            subscribeToDevice(deviceId)
            {
                if (!this.ws || !deviceId) return;

                console.log(`Subscribing to device ${deviceId}`);
                this.ws.send({
                    type: 'subscribe',
                    deviceId: deviceId
                }).catch(error => {
                    console.error('Failed to subscribe to device:', error);
                });
            }

            /**
             * Show a fatal error message
             * @param {string} title - Error title
             * @param {string} message - Error message
             */
            showFatalError(title, message)
            {
                console.error(`[FATAL] ${title}: ${message}`);oo

                // If UI is available, show error
                if (this.ui && typeof this.ui.showError === 'function') {
                    this.ui.showError(title, message);
                } else {
                    // Fallback to alert if UI is not available
                    alert(`${title}: ${message}`);
                }
            }

            /**
             * Handle WebSocket messages
             * @param {Object|string} event - The WebSocket message event
             */
            handleWebSocketMessage(event)
            {
                try {
                    const data = typeof event === 'string' ? JSON.parse(event) : event;
                    console.log('WebSocket message received:', data);

                    if (!data || !data.type) {
                        console.warn('Received WebSocket message without type:', data);
                        return;
                    }

                    // Emit the message to any listeners
                    if (typeof this.emit === 'function') {
                        this.emit('message', data);
                    }

                    // Handle different message types
                    switch (data.type) {
                        case 'device:status':
                            if (typeof this.handleDeviceStatusUpdate === 'function') {
                                this.handleDeviceStatusUpdate(data);
                            }
                            break;

                        case 'device:data':
                            if (typeof this.handleDeviceDataUpdate === 'function') {
                                this.handleDeviceDataUpdate(data);
                            }
                            break;

                        case 'notification':
                            if (this.ui && typeof this.ui.showNotification === 'function') {
                                this.ui.showNotification(data.message, data.level || 'info');
                            }
                            break;

                        default:
                            console.log('Unhandled WebSocket message type:', data.type);
                    }
                } catch (error) {
                    console.error('Error processing WebSocket message:', error);
                    if (typeof this.emit === 'function') {
                        this.emit('error', error);
                    }
                }
            }

            /**
             * Refresh the currently active section
             */
            async
            refreshCurrentSection()
            {
                try {
                    // Implement refresh logic based on current section
                    const activeSection = this.currentSection || 'dashboard';

                    switch (activeSection) {
                        case 'dashboard':
                            return Promise.all([
                                this.loadDashboardStats().then(stats => {
                                    this.updateDashboardStats(stats);
                                    return stats;
                                }),
                                this.deviceManager.loadDevices().then(devices => {
                                    this.updateDevicesList(devices);
                                    return devices;
                                })
                            ]);
                        case 'devices':
                            return this.deviceManager.loadDevices()
                                .then(devices => {
                                    this.updateDevicesList(devices);
                                    return devices;
                                })
                                .catch(error => {
                                    console.error('Error refreshing devices:', error);
                                    throw error;
                                });
                        default:
                            console.warn('No refresh handler for section:', activeSection);
                            return Promise.resolve();
                    }
                } catch (error) {
                    console.error('Error in refreshCurrentSection:', error);
                    return Promise.reject(error);
                    handleError('Failed to refresh data', error, this.ui);
                } finally {
                    this.setLoading(false);
                }
            }

            /**
             * Show a section and hide others
             */
            showSection(section, data = null)
            {
                // Hide all sections
                document.querySelectorAll('.content-section').forEach(el => {
                    el.style.display = 'none';
                });

                // Show the selected section
                const sectionElement = document.getElementById(`${section}-section`);
                if (sectionElement) {
                    sectionElement.style.display = 'block';
                    this.currentSection = section;

                    // Update active navigation
                    this.updateActiveNav(section);

                    // Load section data if needed
                    this.loadSectionData(section, data);
                }
            }

            /**
             * Update active navigation state
             */
            updateActiveNav(activeSection)
            {
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.dataset.section === activeSection) {
                        link.classList.add('active');
                        link.setAttribute('aria-current', 'page');
                    } else {
                        link.classList.remove('active');
                        link.removeAttribute('aria-current');
                    }
                });
            }

            /**
             * Set loading state
                        this.ui.showNotification(
                            error.message || 'Login failed. Please check your credentials and try again.',
                            'error'
                        );
                    } else {
                        console.error('UI not available to show error:', error.message);
                    }

                    // Clear password field on error
                    const passwordField = document.getElementById('password');
                    if (passwordField) passwordField.value = '';

                    // Re-throw the error to be handled by the caller if needed
                    throw error;
                } finally {
                    this.setLoading(false);
                }
            }

            /**
             * Show login form
             */
            /**
             * Show login form
             */
            showLogin() {
                // Only redirect if we're not already on the login page
                if (!window.location.pathname.endsWith('/admin/login') &&
                    !window.location.pathname.endsWith('/admin/')) {
                    window.location.href = '/admin/';
                } else {
                    // If we're already on the login page, just show the login form
                    const loginScreen = document.getElementById('login-screen');
                    const mainApp = document.getElementById('app');

                    if (loginScreen) loginScreen.style.display = 'flex';
                    if (mainApp) mainApp.classList.add('d-none');

                    // Clear any existing token
                    AuthService.setToken(null);

                    // Set up login form submission
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) {
                        loginForm.onsubmit = async (e) => {
                            e.preventDefault();
                            const email = document.getElementById('email')?.value;
                            const password = document.getElementById('password')?.value;

                            if (email && password) {
                                await this.handleLogin(email, password);
                            }
                        };
                    }
                }
            }

            /**
             * Handle login form submission
             * @param {string} email - User's email
             * @param {string} password - User's password
             */
            async handleLogin(email, password) {
                this.setLoading(true, 'Signing in...');

                try {
                    const response = await fetch('/api/auth/admin/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({email, password})
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Login failed');
                    }

                    if (!data.token) {
                        throw new Error('No authentication token received');
                    }

                    // Save the token
                    AuthService.setToken(data.token);

                    // Update the API service with the new token
                    this.api = new ApiService();

                    // Initialize the application
                    await this.initializeApp();

                    // Hide login screen and show main app
                    const loginScreen = document.getElementById('login-screen');
                    const mainApp = document.getElementById('app');

                    if (loginScreen) loginScreen.style.display = 'none';
                    if (mainApp) mainApp.classList.remove('d-none');

                    // Redirect to dashboard
                    window.location.href = '/admin/dashboard';

                } catch (error) {
                    console.error('Login error:', error);
                    if (this.ui && typeof this.ui.showNotification === 'function') {
                        this.ui.showNotification(
                            error.message || 'Login failed. Please check your credentials and try again.',
                            'error'
                        );
                    } else {
                        console.error('UI not available to show error:', error.message);
                    }

                    // Clear password field on error
                    const passwordField = document.getElementById('password');
                    if (passwordField) passwordField.value = '';

                    // Re-throw the error to be handled by the caller if needed
                    throw error;
                } finally {
                    this.setLoading(false);
                }
            }
}

/**
 * Handle WebSocket messages
 * @param {Object|string} event - The WebSocket message event
 */
handleWebSocketMessage(event)
{
try {
const data = typeof event === 'string' ? JSON.parse(event) : event;
console.log('WebSocket message received:', data);


// Make AdminPanel available globally in browser environment
if (typeof window !== 'undefined') {
    try {
        window.AdminPanel = AdminPanel;
    } catch (e) {
        console.error('Failed to set AdminPanel on window:', e);
    }
}

// Export the AdminPanel class
export { AdminPanel };
